name: Infrastructure deployment

on:
  push:
    branches:
      - tf-automation
  pull_request:

jobs:
    terraform:
        name: 'Terraform'
        runs-on: ubuntu-latest

        #env:
          #GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.TF_CREDS_GCP }}
          
        defaults:
          run:
            working-directory: ./terraform

        steps:
  
          - name: Checkout
            uses: actions/checkout@v3

          - name: Setup Terraform
            uses: hashicorp/setup-terraform@v1

          - name: Directory Variable Setup
            run: |
              GCP_OUTPUT_PATH=$RUNNER_TEMP/GCP
              AWS_OUTPUT_PATH=$RUNNER_TEMP/AWS

          - name: Credentials Setup
            env:
              GCP_CRED: ${{ secrets.TF_CREDS_GCP }}
              AWS_CONFIG: ${{ secrets.TF_CONFIG_AWS }}
              AWS_CRED: ${{ secrets.TF_CREDS_AWS }}
            run: |
              echo $GCP_CRED > $GCP_OUTPUT_PATH/credentials.json
              echo $AWS_CONFIG > $AWS_OUTPUT_PATH/config
              echo $AWS_CRED > $AWS_OUTPUT_PATH/credentials
        
          - name: Terraform Format
            id: fmt
            run: terraform fmt -check

          - name: Terraform Init
            id: init
            run: terraform init

          - name: Terraform Validate
            id: validate
            run: terraform validate -no-color

          - name: Terraform Plan
            id: plan
            if: github.event_name == 'pull_request'
            run: terraform plan -no-color
            continue-on-error: true

          - name: Update Pull Request
            uses: actions/github-script@0.9.0
            if: github.event_name == 'pull_request'
            env:
              PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
            with:
              github-token: ${{ secrets.GITHUB_TOKEN }}
              script: |
                const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
                #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
                #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
                #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`

                <details><summary>Show Plan</summary>

                \`\`\`\n
                ${process.env.PLAN}
                \`\`\`

                </details>

                *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                github.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: output
                })

          - name: Terraform Plan Status
            if: steps.plan.outcome == 'failure'
            run: exit 1

          - name: Terraform Apply
            if: github.ref == 'refs/heads/main' && github.event_name == 'push'
            run: terraform apply -auto-approve

